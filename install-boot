#!/bin/bash

# =================================================================
# Installer Hokage-BOT v3.0 (Modular dari GitHub)
# =================================================================

# --- KONFIGURASI REPOSITORY (GANTI DENGAN URL REPO ANDA!) ---
APP_REPO_URL="https://github.com/NAMA_ANDA/NAMA_REPO_BOT_ANDA.git"
BACKEND_REPO_URL="https://github.com/hokagelegend9999/Telegram-bot.git"

# --- Direktori Tujuan ---
APP_DIR="/opt/hokage-bot"
BACKEND_DIR="/usr/bin/bot-telegram"
SERVICE_FILE="/etc/systemd/system/hokage-bot.service"

# --- Warna ---
GREEN='\033[0;32m'; YELLOW='\033[1;33m'; RED='\033[0;31m'; NC='\033[0m'

# --- FUNGSI ---

showHeader() {
    clear
    echo -e "${GREEN}========================================================${NC}"
    echo -e "${GREEN}==         Installer Hokage-BOT v3.0 (Modular)        ==${NC}"
    echo -e "${GREEN}========================================================${NC}"
    echo
}

checkRoot() { if [ "$(id -u)" -ne 0 ]; then echo -e "${RED}Error: Jalankan sebagai root.${NC}"; exit 1; fi; }

run_cleanup() {
    echo -e "${YELLOW}> Membersihkan instalasi lama...${NC}"
    systemctl stop hokage-bot.service > /dev/null 2>&1
    rm -rf "$APP_DIR" "$BACKEND_DIR" "$SERVICE_FILE"
}

promptForCredentials() {
    echo -e "${YELLOW}> Meminta kredensial...${NC}"
    read -p "Masukkan Token Bot Anda: " BOT_TOKEN
    read -p "Masukkan ID Telegram Admin Anda: " ADMIN_ID
    if [ -z "$BOT_TOKEN" ] || [ -z "$ADMIN_ID" ]; then echo -e "${RED}Error: Token/ID kosong.${NC}"; exit 1; fi
}

installDependencies() {
    echo -e "${YELLOW}> Menginstal dependensi...${NC}"
    apt-get update > /dev/null 2>&1
    apt-get install -y git python3-venv > /dev/null 2>&1
}

cloneRepositories() {
    echo -e "${YELLOW}> Mengunduh file bot dari GitHub...${NC}"
    mkdir -p "$APP_DIR"
    git clone --depth 1 "$APP_REPO_URL" "$APP_DIR"
    if [ $? -ne 0 ]; then echo -e "${RED}Gagal mengunduh repo aplikasi bot. Cek URL.${NC}"; exit 1; fi

    echo -e "${YELLOW}> Mengunduh skrip backend dari GitHub...${NC}"
    mkdir -p "$BACKEND_DIR"
    git clone --depth 1 "$BACKEND_REPO_URL" "$BACKEND_DIR"
    chmod +x ${BACKEND_DIR}/*
}

configureBot() {
    echo -e "${YELLOW}> Mengonfigurasi bot dengan token dan ID...${NC}"
    CONFIG_TEMPLATE="${APP_DIR}/config.py.example"
    CONFIG_FILE="${APP_DIR}/config.py"

    if [ ! -f "$CONFIG_TEMPLATE" ]; then
        echo -e "${RED}Error: File 'config.py.example' tidak ditemukan di repo Anda.${NC}"; exit 1
    fi
    
    cp "$CONFIG_TEMPLATE" "$CONFIG_FILE"
    
    # Mengisi nilai menggunakan sed
    sed -i "s/GANTI_DENGAN_TOKEN_BOT/${BOT_TOKEN}/g" "$CONFIG_FILE"
    sed -i "s/0 # Akan diganti dengan ID Admin/${ADMIN_ID}/g" "$CONFIG_FILE"
    sed -i "s/SERVER_IP = \"\"/SERVER_IP = \"$(hostname -I | awk '{print $1}')\"/g" "$CONFIG_FILE"
}

finalizeInstallation() {
    echo -e "${YELLOW}> Menyelesaikan instalasi...${NC}"
    # Setup Python Virtual Environment
    python3 -m venv ${APP_DIR}/venv
    source ${APP_DIR}/venv/bin/activate
    pip install -r ${APP_DIR}/requirements.txt > /dev/null 2>&1
    deactivate

    # Setup Systemd Service
    cat <<EOF > ${SERVICE_FILE}
[Unit]
Description=Hokage-BOT Telegram Modular Service
After=network.target
[Service]
User=root
WorkingDirectory=${APP_DIR}
ExecStart=${APP_DIR}/venv/bin/python3 main.py
Restart=always
[Install]
WantedBy=multi-user.target
EOF

    # Start service
    systemctl daemon-reload
    systemctl enable hokage-bot.service > /dev/null 2>&1
    systemctl start hokage-bot.service
}

# --- EKSEKUSI UTAMA ---
main() {
    showHeader
    checkRoot
    run_cleanup
    promptForCredentials
    installDependencies
    cloneRepositories
    configureBot
    finalizeInstallation

    echo
    echo -e "${GREEN}========================================================${NC}"
    echo -e "${GREEN}==         INSTALASI MODULAR BERHASIL SELESAI         ==${NC}"
    echo -e "${GREEN}========================================================${NC}"
    echo
    echo "Bot Anda kini berjalan dengan kode dari repositori GitHub Anda."
    echo "Untuk memperbarui bot, cukup 'git push' ke repo Anda lalu jalankan installer ini lagi."
    echo "Status: ${YELLOW}systemctl status hokage-bot.service${NC}"
}

main
